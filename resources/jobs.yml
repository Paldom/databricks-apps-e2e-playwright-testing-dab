resources:
  jobs:
    # 1) Monitoring job: Playwright healthcheck against the app URL.
    #    Uses a custom container with Playwright + Chromium pre-installed.
    monitor_app_job:
      name: "${bundle.name}-monitor-app-${bundle.target}"
      parameters:
        - name: "scope"
          default: ${resources.secret_scopes.app_oauth_scope.name}

      # Optional: run as a schedule (Quartz cron).
      schedule:
        quartz_cron_expression: "${var.schedule_quartz_cron}"
        timezone_id: "${var.schedule_timezone}"
        pause_status: UNPAUSED

      max_concurrent_runs: 1

      tasks:
        - task_key: playwright_healthcheck
          existing_cluster_id: ${resources.clusters.monitoring_cluster.id}
          notebook_task:
            notebook_path: ../src/playwright_test.ipynb
            base_parameters:
              # Pass the app resource name only; the notebook resolves the full host using workspace config.
              app_url: "${resources.apps.hello-world-app.name}"
              scope: "{{job.parameters.scope}}"
              api_path: "${var.api_route_path}"
              expected_header_text: "${var.expected_header_text}"
              expected_api_message: "${var.expected_api_message}"
              artifacts_volume_path: "${var.artifacts_volume_path}"

    # 2) E2E test job: runs the monitoring job.
    e2e_test_job:
      name: "${bundle.name}-e2e-${bundle.target}"
      tasks:
        - task_key: run_monitor
          run_job_task:
            job_id: ${resources.jobs.monitor_app_job.id}
